<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>decimalEngine ‚Äì Real Mobile Gravity FIXED</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { margin: 0; background: black; overflow: hidden; }
  canvas {
    background: white;
    display: block;
    touch-action: none;
  }
</style>
</head>

<body>

<!-- UI -->
<div class="fixed bottom-3 left-3 right-3 md:top-4 md:left-4 md:right-auto md:w-72 bg-black text-white rounded-2xl p-4 space-y-3 z-10">
  <h1 class="text-center font-bold">
    decimal<span class="opacity-70">Engine</span>
  </h1>

  <select id="mode" class="w-full bg-white text-black rounded px-3 py-2">
    <option value="ball">Place Ball</option>
    <option value="throw">Throw Ball</option>
  </select>

  <button id="clear" class="w-full bg-white text-black rounded py-2 font-semibold">
    Clear
  </button>

  <p class="text-xs opacity-60 text-center">
    Tap once to enable motion üì±
  </p>
</div>

<canvas id="canvas"></canvas>

<script>
/* ======================
   CANVAS
====================== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* ======================
   ROOM
====================== */
const room = {
  w: Math.min(700, innerWidth - 40),
  h: Math.min(450, innerHeight - 40),
  x: () => canvas.width / 2,
  y: () => canvas.height / 2
};

/* ======================
   WORLD
====================== */
const balls = [];
const restitution = 0.6;
const friction = 0.995;

/* REAL GRAVITY VECTOR */
let gX = 0;
let gY = 0.8;

/* ======================
   DEVICE MOTION
====================== */
let motionEnabled = false;

function enableMotion() {
  if (motionEnabled) return;

  if (
    typeof DeviceMotionEvent !== "undefined" &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    DeviceMotionEvent.requestPermission().then(res => {
      if (res === "granted") {
        window.addEventListener("devicemotion", handleMotion);
        motionEnabled = true;
      }
    });
  } else {
    window.addEventListener("devicemotion", handleMotion);
    motionEnabled = true;
  }
}

function handleMotion(e) {
  if (!e.accelerationIncludingGravity) return;

  const ax = e.accelerationIncludingGravity.x;
  const ay = e.accelerationIncludingGravity.y;

  /* PORTRAIT MODE FIX */
  gX = -ax * 0.12;   // ‚Üê FIXED inversion
  gY = ay * 0.12;
}

/* ======================
   OBJECTS
====================== */
function addBall(x, y, vx=0, vy=0) {
  balls.push({ x, y, vx, vy, r: 12 });
}

/* INITIAL BALL */
addBall(room.x(), room.y());

/* ======================
   COLLISION (ROOM)
====================== */
function resolveRoom(b) {
  const left   = room.x() - room.w/2;
  const right  = room.x() + room.w/2;
  const top    = room.y() - room.h/2;
  const bottom = room.y() + room.h/2;

  if (b.x - b.r < left) {
    b.x = left + b.r;
    b.vx *= -restitution;
  }
  if (b.x + b.r > right) {
    b.x = right - b.r;
    b.vx *= -restitution;
  }
  if (b.y - b.r < top) {
    b.y = top + b.r;
    b.vy *= -restitution;
  }
  if (b.y + b.r > bottom) {
    b.y = bottom - b.r;
    b.vy *= -restitution;
  }
}

/* ======================
   UPDATE
====================== */
function update() {
  balls.forEach(b => {
    b.vx += gX;
    b.vy += gY;

    b.x += b.vx;
    b.y += b.vy;

    b.vx *= friction;
    b.vy *= friction;

    resolveRoom(b);
  });
}

/* ======================
   DRAW
====================== */
function drawRoom() {
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 3;
  ctx.strokeRect(
    room.x() - room.w/2,
    room.y() - room.h/2,
    room.w,
    room.h
  );
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawRoom();

  balls.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fillStyle = "#000";
    ctx.fill();
  });
}

/* ======================
   LOOP
====================== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ======================
   INPUT
====================== */
const mode = document.getElementById("mode");
const clearBtn = document.getElementById("clear");

let sx=0, sy=0;

canvas.addEventListener("pointerdown", e => {
  enableMotion();
  sx = e.clientX;
  sy = e.clientY;
});

canvas.addEventListener("pointerup", e => {
  if (mode.value === "ball") {
    addBall(e.clientX, e.clientY);
  } else {
    addBall(
      sx,
      sy,
      (sx - e.clientX) * 0.15,
      (sy - e.clientY) * 0.15
    );
  }
});

clearBtn.onclick = () => {
  balls.length = 0;
  addBall(room.x(), room.y());
};
</script>

</body>
</html>
